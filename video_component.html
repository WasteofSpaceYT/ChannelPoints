<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-U1DAWAznBHeqEIlVSCgzq+c9gqGAJn5c/t99JyeKa9xxaYpSvHU5awsuZVVFIhvj" crossorigin="anonymous"></script>
    <title>Extend</title>
</head>
<style>
    .body {
        font-size: 50px;
    }
    
    .center {
        margin: 0;
        position: absolute;
        top: 50%;
        left: 50%;
        -ms-transform: translate(-50%, -50%);
        transform: translate(-50%, -50%);
    }
    
    .grid-container {
        display: grid;
        grid-gap: 50px;
    }
    
    .button {
        box-shadow: 0 8px 16px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
        transition-duration: 0.4s;
        font-size: 50px;
        margin: 10px
    }
    
    .button:hover {
        box-shadow: 0 12px 16px 0 rgba(0, 0, 0, 0.24), 0 17px 50px 0 rgba(0, 0, 0, 0.19);
        background-color: black;
        /* Green */
        color: white;
        font-size: 50px;
    }
</style>

<body>
    <div id='homeContent'>
        <div id="divider" , class="body"></div>
        <button id='redeembutton' , class='button'>Redeem</button>
        <button id='rewardbutton' , class='button'>Rewards</button>
        <p class='body' , id='redeemtext'></p>
    </div>
    <div id='rewardcontent'>
        <button id='backButton' , class='button'>&lt</button>

        <table class="table table-hover">
            <tr>
                <th>Reward</th>
                <th>Description</th>
                <th>Cost</th>
            </tr>
        </table>
    </div>
    <script src="https://apis.google.com/js/platform.js"></script>

    <!--<div class="g-ytsubscribe" data-channelid="UCbbwY01aj95QSp6vo-88kBw" data-layout="full" data-count="default"></div>-->
    <script src="https://extension-files.twitch.tv/helper/v1/twitch-ext.min.js"></script>
    <script>
        document.getElementById('rewardcontent').hidden = true;
        document.getElementById('redeembutton').addEventListener('click', function() {
            function calcNextRedeem() {
                // calculate 15 minutes after lastRedeemed
                var now = new Date();
                var nowtime = now.getTime();
                newTime = nowtime + 900000
                return newTime.toString()
            }
            const d = new Date();
            storage = window.localStorage;
            // list items in localStorage
            window.Twitch.ext.rig.log('lastRedeemed: ' + storage.getItem('lastRedeemed') + ' nextRedeem: ' + storage.getItem('nextRedeem') + ' amount: ' + storage.getItem('amount'));
            if ((storage.getItem('nextRedeem') <= d.getTime()) || (storage.getItem('nextRedeem') == null) || (storage.getItem('lastRedeemed') == null)) {
                var amount = storage.getItem('amount');
                amountStorage = parseInt(amount) + 15
                storage.setItem('amount', amountStorage);
                document.getElementById("redeemtext").textContent = "Redeemed your 15 points.";
                document.getElementById('redeemtext').style.color = "green";
                setTimeout(function() {
                    document.getElementById("redeemtext").textContent = "";
                }, 1000);
                divider = document.getElementById("divider");
                divider.innerHTML = `<h1><center>Welcome!</center></h1> <br> <p>You have ${amountStorage} watts.</p>`
                storage.setItem('lastRedeemed', d.getTime().toString());
                storage.setItem('nextRedeem', calcNextRedeem(d.getTime()));
            } else {
                document.getElementById("redeemtext").textContent = "You can only redeem once every 15 minutes.";
                document.getElementById('redeemtext').style.color = 'red';
                setTimeout(function() {
                    document.getElementById("redeemtext").textContent = "";
                }, 1000);
            }
        });
        document.getElementById('rewardbutton').addEventListener('click', function() {
            document.getElementById('homeContent').hidden = true;
            document.getElementById('rewardcontent').hidden = false;
        });
        document.getElementById('backButton').addEventListener('click', function() {
            document.getElementById('homeContent').hidden = false;
            document.getElementById('rewardcontent').hidden = true;
        });
        window.Twitch.ext.onAuthorized((auth) => {
            if (auth.userId.toLowerCase().startsWith("a")) {
                divider = document.getElementById('divider');
                divider.innerHTML = '<h1 class="center">You are not logged in.</h1>';
                document.getElementById('redeembutton').hidden = true;
                document.getElementById('rewardcontent').hidden = true;
                document.getElementById('rewardbutton').hidden = true;
            } else {
                document.getElementById('rewardcontent').hidden = true;
                // make storage variable for local storage
                var storage = window.localStorage;
                // read storage variable for amount
                var amountStorage = storage.getItem('amount');
                Twitch.ext.rig.log(amountStorage);
                if (amountStorage == null) {
                    amountStorage = 0
                        // set storage variable for userId
                    storage.setItem('amount', amountStorage);
                }
                divider.innerHTML = `<h1><center>Welcome!</center></h1> <br> <p>You have ${amountStorage} watts.</p>`
            }
        });
    </script>
</body>

</html>